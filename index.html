<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vacinas COVID-19 Portugal - Progresso</title>

    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Varela+Round&display=swap"
      rel="stylesheet"
    />

    <style>
      html {
        display: flex;
        justify-content: center;
        min-height: 100%;
      }

      body {
        margin: 0;
        background: #212121;
        display: flex;
        width: clamp(1000px, 80vw, 200px);
        flex-direction: column;
        align-content: center;
        justify-content: center;
        color: white;
        font-family: "Varela Round", sans-serif;
        text-align: center;
      }

      .meter {
        box-sizing: content-box;
        height: 20px; /* Can be anything */
        position: relative;
        margin: 60px 10px 20px 10px; /* Just for demo spacing */
        background: #555;
        border-radius: 25px;
        padding: 10px;
        box-shadow: inset 0 -1px 1px rgba(255, 255, 255, 0.3);
      }
      .meter > span.bar {
        display: block;
        height: 50%;
        border-top-right-radius: 8px;
        border-bottom-right-radius: 8px;
        border-top-left-radius: 20px;
        border-bottom-left-radius: 20px;
        background-color: rgb(43, 194, 83);
        background-image: linear-gradient(
          center bottom,
          rgb(43, 194, 83) 37%,
          rgb(84, 240, 84) 69%
        );
        box-shadow: inset 0 2px 9px rgba(255, 255, 255, 0.3),
          inset 0 -2px 6px rgba(0, 0, 0, 0.4);
        position: absolute;
        overflow: hidden;
        transition: all cubic-bezier(0, 0, 0.48, 1.06) 1s;
      }

      #first-progress {
        z-index: 1;
      }

      #second-progress {
        z-index: 2;
        background-color: rgb(26, 117, 50);
        background-image: linear-gradient(
          center bottom,
          rgb(26, 117, 50) 37%,
          rgb(36, 143, 36) 69%
        );
      }

      .meter > span.goal {
        position: absolute;
        left: 70%;
        top: 0px;
        height: 100%;
        width: 0px;
        border: 1px dashed #bfbfbf;
      }

      .meter > span.goal:before {
        content: "70%";
        position: relative;
        top: 100%;
      }

      .stats {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
      }

      .stats p {
        margin: 10px;
      }

      .stats .stats-num {
        font-size: 2em;
      }

      footer {
        margin-top: 50px;
        color: #bfbfbf;
        font-size: 0.8rem;
      }

      a {
        text-decoration: none;
        color: rgb(102, 180, 102);
      }

      .sup-inc {
        color: rgb(102, 180, 102);
      }

      .chart-container {
        margin-top: 20px;
      }

      #vaccinesChart {
        max-width: 90vw;
      }
    </style>
  </head>
  <body>
    <h1>Progresso Vacinação Portugal</h1>

    <div class="stats">
      <div>
        <p class="stats-title">Primeira Dose</p>
        <p class="stats-num">
          <span id="first-num">-</span
          ><sup class="sup-inc">+<span id="first-inc"></span></sup>
        </p>
        <p class="stats-per" id="first-per">-%</p>
        <p id="first-estimative"></p>
      </div>
      <div>
        <p class="stats-title">Segunda Dose</p>
        <p class="stats-num">
          <span id="second-num">-</span
          ><sup class="sup-inc">+<span id="second-inc"></span></sup>
        </p>
        <p class="stats-per" id="second-per">-%</p>
        <p id="second-estimative"></p>
      </div>
    </div>

    <div class="progress">
      <div class="meter">
        <span class="bar" id="second-progress" style="width: 0%"></span>
        <span class="bar" id="first-progress" style="width: 0%"></span>
        <span class="goal"></span>
      </div>
    </div>

    <div class="chart-container">
      <canvas id="vaccinesChart"></canvas>
    </div>

    <footer>
      <p>
        Data from
        <a
          href="https://github.com/dssg-pt/covid19pt-data"
          target="_blank"
          rel="noopener noreferrer"
          >dssg-pt</a
        >
      </p>
      <p>Last updated on <span id="last-updated"></span></p>
      <p>
        Percentages use a population of <span id="population"></span> people
      </p>
      <p>Estimates are calculated based on the increase of the last 7 days</p>
      <p>
        Source Code on
        <a
          href="https://github.com/diogotcorreia/covid19-pt-progress-bar/"
          target="_blank"
          rel="noopener noreferrer"
          >GitHub</a
        >
      </p>
    </footer>

    <script
      async
      defer
      src="https://cdn.jsdelivr.net/npm/chart.js@3.2.0/dist/chart.min.js"
    ></script>
    <script>
      const PORTUGAL_POPULATION = 10302674;

      document.getElementById("population").innerText =
        PORTUGAL_POPULATION.toLocaleString("en-US");

      const updateEstimatives = (current_doses, new_doses, element) => {
        const dailyAvgIncrease =
          [...new_doses]
            .splice(-7)
            .map((v) => parseInt(v, 10))
            .reduce((acc, v) => acc + v, 0) / 7;

        const remaining = PORTUGAL_POPULATION * 0.7 - current_doses;
        if (remaining < 0) return; // over 70% already!

        console.log(dailyAvgIncrease, remaining);

        const daysLeft = remaining / dailyAvgIncrease;

        console.log(daysLeft);
        const targetDate = new Date();
        targetDate.setTime(Date.now() + daysLeft * 24 * 3600 * 1000);

        element.innerText = `Estimated to reach 70% by ${targetDate.toDateString()}`;
      };

      const animateValue = (obj, start, end, duration) => {
        let startTimestamp = null;
        const step = (timestamp) => {
          if (!startTimestamp) startTimestamp = timestamp;
          const progress = Math.min((timestamp - startTimestamp) / duration, 1);
          obj.innerHTML = Math.floor(
            progress * (end - start) + start
          ).toLocaleString("en-US");
          if (progress < 1) {
            window.requestAnimationFrame(step);
          }
        };
        window.requestAnimationFrame(step);
      };

      const updateChart = (data) => {
        const rows = data
          .split("\n")
          .filter((v) => v.trim())
          .splice(-30) // get last 30 days
          .map((v) => v.split(","));

        const getColumn = (i) => rows.map((v) => v[i]);
        const [date, doses1, doses1_novas, doses2, doses2_novas] = [
          0, 3, 4, 5, 6,
        ].map(getColumn);

        updateEstimatives(
          doses1.slice(-1)[0],
          doses1_novas,
          document.getElementById("first-estimative")
        );
        updateEstimatives(
          doses2.slice(-1)[0],
          doses2_novas,
          document.getElementById("second-estimative")
        );

        console.log(date, doses1, doses1_novas, doses2, doses2_novas);

        const ctx = document.getElementById("vaccinesChart").getContext("2d");
        new Chart(ctx, {
          data: {
            labels: date,
            datasets: [
              {
                type: "line",
                label: "Primeira Dose Total",
                data: doses1,
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderColor: "rgba(255, 99, 132, 1)",
              },
              {
                type: "line",
                label: "Segunda Dose Total",
                data: doses2,
                backgroundColor: "rgba(54, 162, 235, 0.2)",
                borderColor: "rgba(54, 162, 235, 1)",
              },
              {
                type: "bar",
                label: "Primeira Dose Incremento",
                data: doses1_novas,
                backgroundColor: "rgba(255, 206, 86, 0.2)",
                borderColor: "rgba(255, 206, 86, 1)",
                borderWidth: 1,
                yAxisID: "y1",
              },
              {
                type: "bar",
                label: "Segunda Dose Incremento",
                data: doses2_novas,
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 1,
                yAxisID: "y1",
              },
            ],
          },
          options: {
            responsive: true,
            color: "rgba(255,255,255,1)",
            scales: {
              y: {
                beginAtZero: true,
              },
              y1: {
                type: "linear",
                display: true,
                position: "right",

                // grid line settings
                grid: {
                  drawOnChartArea: false, // only want the grid lines for one axis to show up
                },
              },
            },
          },
        });
      };

      const updateContent = (data) => {
        const [
          date,
          _doses,
          _doses_novas,
          doses1,
          doses1_novas,
          doses2,
          doses2_novas,
        ] = data
          .split("\n")
          .filter((v) => v.trim())
          .reverse()[0]
          .split(",");

        document.getElementById("last-updated").innerText = new Date(
          date.split("-").reverse().join("-")
        ).toDateString();

        console.log(doses1, doses2);

        const doses1_perc = Math.round((doses1 / PORTUGAL_POPULATION) * 100);
        const doses2_perc = Math.round((doses2 / PORTUGAL_POPULATION) * 100);

        animateValue(
          document.getElementById("first-num"),
          0,
          parseInt(doses1, 10),
          800
        );
        animateValue(
          document.getElementById("second-num"),
          0,
          parseInt(doses2, 10),
          800
        );

        animateValue(
          document.getElementById("first-inc"),
          0,
          parseInt(doses1_novas, 10),
          800
        );
        animateValue(
          document.getElementById("second-inc"),
          0,
          parseInt(doses2_novas, 10),
          800
        );

        document.getElementById("first-per").innerText = `${doses1_perc}%`;
        document.getElementById("second-per").innerText = `${doses2_perc}%`;

        document.getElementById(
          "first-progress"
        ).style.width = `${doses1_perc}%`;
        document.getElementById(
          "second-progress"
        ).style.width = `${doses2_perc}%`;

        updateChart(data);
      };

      fetch(
        "https://raw.githubusercontent.com/dssg-pt/covid19pt-data/master/vacinas.csv"
      )
        .then(function (response) {
          return response.text();
        })
        .then(updateContent)
        .catch(console.error);
    </script>
    <!-- Privacy focused analytics -->
    <script
      async
      defer
      data-website-id="6e0213fc-b9b1-4b95-8c4b-81b98b2597f2"
      src="https://umami.diogotc.com/umami.js"
    ></script>
  </body>
</html>
